<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOS Ultimate | AI Powered</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons & FontAwesome -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #F8FAFC;
            --text-primary: #0F172A;
            --accent-primary: #6366F1;
            --accent-secondary: #8B5CF6;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-primary); -webkit-font-smoothing: antialiased; }

        /* Utilit√°rios */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Edi√ß√£o de Texto */
        [contenteditable="true"] { outline: none; transition: all 0.2s; border: 1px dashed transparent; cursor: text; }
        [contenteditable="true"]:hover { border-color: #cbd5e1; background-color: rgba(255,255,255,0.5); }
        [contenteditable="true"]:focus { background-color: #fff; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); border-style: solid; border-radius: 4px; }
        [contenteditable="true"]:empty:before { content: attr(data-placeholder); color: #94a3b8; font-style: italic; }

        /* AI Elements */
        .ai-gradient { background: linear-gradient(135deg, #6366F1 0%, #A855F7 100%); }
        .ai-chat-window {
            position: fixed; bottom: 100px; right: 30px; width: 350px; height: 500px;
            background: white; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 50; display: none; flex-direction: column; overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .ai-chat-window.open { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-item.active { background-color: #EEF2FF; color: var(--accent-primary); border-right: 3px solid var(--accent-primary); font-weight: 600; }
        
        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 80px; border-radius: 8px; border: 1px solid #E2E8F0; background: white; padding: 4px; font-size: 0.8rem; }
        .calendar-day.today { border: 2px solid var(--accent-primary); background-color: #F5F3FF; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <nav class="w-20 md:w-64 bg-white border-r border-slate-200 flex flex-col justify-between flex-shrink-0 z-20 shadow-sm">
        <div>
            <div class="h-20 flex items-center justify-center md:justify-start md:px-6 border-b border-slate-100">
                <div class="w-10 h-10 rounded-xl ai-gradient text-white flex items-center justify-center text-xl font-bold shadow-lg shadow-indigo-200"><i class="fas fa-brain"></i></div>
                <span class="ml-3 font-bold text-xl hidden md:block tracking-tight text-slate-800">LifeOS <span class="text-xs text-indigo-500 align-top">AI</span></span>
            </div>
            <ul class="flex flex-col py-6 space-y-1 px-2 overflow-y-auto max-h-[calc(100vh-180px)]">
                <li><button onclick="switchTab('dashboard')" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-500 hover:bg-slate-50 transition active" id="btn-dashboard"><i class="ph ph-squares-four text-xl"></i><span class="ml-3 hidden md:block">Vis√£o Geral</span></button></li>
                <li><button onclick="switchTab('daily')" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-500 hover:bg-slate-50 transition" id="btn-daily"><i class="ph ph-sun text-xl"></i><span class="ml-3 hidden md:block">Agenda do Dia</span></button></li>
                <li><button onclick="switchTab('goals')" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-500 hover:bg-slate-50 transition" id="btn-goals"><i class="ph ph-target text-xl"></i><span class="ml-3 hidden md:block">Metas Globais</span></button></li>
                <li><button onclick="switchTab('finances')" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-500 hover:bg-slate-50 transition" id="btn-finances"><i class="ph ph-currency-dollar text-xl"></i><span class="ml-3 hidden md:block">Finan√ßas</span></button></li>
                <li><button onclick="switchTab('study')" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-500 hover:bg-slate-50 transition" id="btn-study"><i class="ph ph-student text-xl"></i><span class="ml-3 hidden md:block">Nexus Estudos</span></button></li>
                <li><button onclick="switchTab('routine')" class="nav-item w-full flex items-center p-3 rounded-lg text-slate-500 hover:bg-slate-50 transition" id="btn-routine"><i class="ph ph-check-circle text-xl"></i><span class="ml-3 hidden md:block">H√°bitos</span></button></li>
            </ul>
        </div>
        <div class="p-4 border-t border-slate-100">
            <button onclick="exportData()" class="flex items-center text-xs text-slate-400 hover:text-indigo-600 transition"><i class="ph ph-download mr-2"></i> <span class="hidden md:inline">Backup</span></button>
            <input type="file" id="import-file" class="hidden" onchange="importData(this)">
            <label for="import-file" class="flex items-center text-xs text-slate-400 hover:text-indigo-600 transition mt-2 cursor-pointer"><i class="ph ph-upload mr-2"></i> <span class="hidden md:inline">Restaurar</span></label>
            <button onclick="hardReset()" class="flex items-center text-xs text-red-400 hover:text-red-600 transition mt-2 cursor-pointer"><i class="ph ph-trash mr-2"></i> <span class="hidden md:inline">Resetar</span></button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden bg-[#F8FAFC] relative">
        <div class="h-full overflow-y-auto p-4 md:p-8 pb-32">
            
            <header class="flex justify-between items-center mb-8">
                <div>
                    <!-- EDIT√ÅVEL: Nome do Usu√°rio -->
                    <h1 class="text-2xl font-bold text-slate-800 outline-none flex items-center gap-2">
                        <span contenteditable="true" id="user-greeting" onblur="saveTextData()">Ol√°!</span>
                        <span class="text-lg">üëã</span>
                    </h1>
                    <p class="text-slate-500 text-sm flex items-center gap-2">
                        <span id="current-date"></span>
                    </p>
                </div>
            </header>

            <!-- 1. DASHBOARD -->
            <section id="dashboard" class="tab-content active">
                <!-- AI INSIGHT MELHORADO -->
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-6 text-white mb-8 shadow-lg relative overflow-hidden group">
                    <!-- Fundo decorativo -->
                    <div class="absolute -right-10 -top-10 text-white opacity-5 text-9xl rotate-12"><i class="fas fa-brain"></i></div>
                    
                    <h2 class="text-sm font-bold mb-3 flex items-center gap-2 uppercase tracking-wider text-indigo-200">
                        <i class="fas fa-sparkles text-yellow-300"></i> Insight do Dia
                    </h2>
                    
                    <p id="ai-daily-insight" class="text-white text-xl md:text-2xl font-medium leading-relaxed max-w-3xl">
                        Carregando sua an√°lise di√°ria...
                    </p>
                    
                    <div class="mt-6 flex gap-3">
                        <button onclick="LifeAI.generateInsight()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg text-xs font-bold transition backdrop-blur-sm flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i> Novo Insight
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="ph ph-target text-indigo-500"></i> Foco Principal</h3>
                        </div>
                        <!-- EDIT√ÅVEL: Lista de Foco Livre -->
                        <div id="dash-focus-notes" contenteditable="true" class="w-full min-h-[120px] text-lg text-slate-700 bg-slate-50 p-6 rounded-xl border border-slate-100 focus:bg-white focus:ring-2 focus:ring-indigo-100 focus:border-indigo-200 leading-relaxed" data-placeholder="Qual √© a √∫nica coisa que, se feita hoje, tornar√° todo o resto mais f√°cil? Escreva aqui..."></div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-700 mb-4">Progresso Geral</h3>
                            <div class="space-y-5">
                                <div>
                                    <div class="flex justify-between text-xs text-slate-500 mb-1 font-medium"><span>METAS DE ESTUDO</span><span class="text-purple-600">65%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="bg-purple-500 h-2.5 rounded-full" style="width: 65%"></div></div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-slate-500 mb-1 font-medium"><span>CONTROLE FINANCEIRO</span><span class="text-green-600">80%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="bg-green-500 h-2.5 rounded-full" style="width: 80%"></div></div>
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-slate-500 mb-1 font-medium"><span>H√ÅBITOS SAUD√ÅVEIS</span><span class="text-blue-600">40%</span></div>
                                    <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="bg-blue-500 h-2.5 rounded-full" style="width: 40%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. DAILY AGENDA -->
            <section id="daily" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-fit">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700">Metas do Dia</h3>
                            <button onclick="LifeAI.suggestDailyGoals()" class="text-xs ai-gradient text-white px-3 py-1.5 rounded-lg shadow-sm hover:opacity-90 transition font-medium flex items-center gap-1"><i class="fas fa-magic"></i> Sugerir</button>
                        </div>
                        <div id="daily-goals-container" class="space-y-3"></div>
                        <button onclick="addDailyGoal()" class="mt-4 w-full text-xs text-slate-500 border border-dashed border-slate-300 bg-slate-50 p-3 rounded-lg hover:border-indigo-400 hover:text-indigo-600 transition font-medium">+ Adicionar Meta R√°pida</button>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-700 mb-4">Lista de Tarefas</h3>
                            <div id="task-list" class="space-y-2"></div>
                            <div class="flex gap-2 mt-4">
                                <input type="text" id="new-task-input" placeholder="O que precisa ser feito?" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-sm outline-none focus:border-indigo-300 focus:ring-2 focus:ring-indigo-50 transition">
                                <button onclick="addTask()" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 font-bold transition"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        
                        <!-- EDIT√ÅVEL: Notas do Dia -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-700 mb-2">Notas & Brainstorm</h3>
                            <div id="daily-notes" contenteditable="true" class="w-full min-h-[150px] text-sm text-slate-600 bg-slate-50 p-4 rounded-lg focus:bg-white focus:ring-2 focus:ring-indigo-50 outline-none leading-relaxed" data-placeholder="Use este espa√ßo para esvaziar a mente..."></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. METAS GLOBAIS -->
            <section id="goals" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Painel de Metas</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="global-goals-grid"></div>
            </section>

            <!-- 4. NEXUS ESTUDOS -->
            <section id="study" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-150px)]">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 flex flex-col gap-2">
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Nexus v3.0</div>
                        <button onclick="renderNexusDashboard()" class="text-left px-4 py-2 rounded-lg bg-indigo-50 text-indigo-700 font-medium text-sm">Dashboard</button>
                        <div class="mt-auto bg-slate-50 p-4 rounded-xl text-center">
                            <div class="text-3xl font-mono font-bold text-slate-700 mb-2" id="nexus-timer">25:00</div>
                            <button onclick="toggleStudyTimer()" id="nexus-timer-btn" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm hover:bg-black transition">Focar</button>
                        </div>
                    </div>
                    <div class="lg:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-100 p-6 overflow-y-auto">
                        <div id="nexus-content-area"></div>
                    </div>
                </div>
            </section>

            <!-- 5. FINAN√áAS -->
            <section id="finances" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-slate-400 font-bold uppercase">Saldo (Calculado)</p><h3 class="text-2xl font-bold text-slate-800 mt-1" id="fin-balance">R$ 0,00</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-green-500 font-bold uppercase">Entradas</p><h3 class="text-2xl font-bold text-green-600 mt-1" id="fin-income">R$ 0,00</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-red-500 font-bold uppercase">Sa√≠das</p><h3 class="text-2xl font-bold text-red-600 mt-1" id="fin-expense">R$ 0,00</h3></div>
                </div>
                <!-- EDIT√ÅVEL: Anota√ß√µes Financeiras -->
                <div class="mb-8">
                    <div id="fin-notes" contenteditable="true" class="w-full bg-yellow-50 border border-yellow-100 p-4 rounded-xl text-sm text-yellow-900 leading-relaxed focus:bg-white focus:ring-2 focus:ring-yellow-200 outline-none" data-placeholder="Nota r√°pida sobre finan√ßas (ex: Pagar boleto dia 20)..."></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-700 mb-4">Nova Transa√ß√£o</h3>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <select id="trans-type" class="p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:border-indigo-300 outline-none"><option value="expense">Sa√≠da</option><option value="income">Entrada</option></select>
                                <input type="number" id="trans-val" placeholder="Valor" class="p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:border-indigo-300 outline-none">
                            </div>
                            <input type="text" id="trans-desc" placeholder="Descri√ß√£o (ex: Supermercado)" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 mb-3 focus:border-indigo-300 outline-none">
                            <button onclick="addTransaction()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-sm hover:bg-black transition">Registrar</button>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-slate-700 mb-4">Hist√≥rico</h3>
                            <div id="transaction-list" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 6. OUTRAS ABAS -->
            <section id="routine" class="tab-content">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800 mb-6">H√°bitos</h2>
                    <div id="habit-list"></div>
                    <button onclick="addHabit()" class="mt-4 text-sm text-indigo-600 font-bold hover:underline">+ Novo H√°bito</button>
                </div>
            </section>

        </div>
    </main>

    <!-- AI CHAT -->
    <div class="fixed bottom-8 right-8 w-14 h-14 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg cursor-pointer hover:bg-indigo-700 transition z-50 hover:scale-110 duration-200" onclick="toggleAIChat()">
        <i class="fas fa-robot text-xl"></i>
    </div>

    <div class="ai-chat-window" id="ai-chat-window">
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <span class="font-bold text-sm flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div> LifeOS AI</span>
            <button onclick="toggleAIChat()" class="hover:text-slate-300"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 p-4 overflow-y-auto space-y-3 bg-slate-50" id="ai-chat-messages">
            <div class="flex justify-start"><div class="bg-white p-3 rounded-2xl rounded-tl-none text-sm shadow-sm text-slate-700 border border-slate-100">Ol√°! Como posso ajudar a organizar seu dia?</div></div>
        </div>
        <div class="p-3 bg-white border-t border-slate-200">
            <form onsubmit="handleAIChat(event)" class="flex gap-2">
                <input type="text" id="ai-chat-input" placeholder="Digite..." class="flex-1 bg-slate-100 border-none rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-100">
                <button type="submit" class="bg-indigo-600 text-white w-9 h-9 rounded-full flex items-center justify-center hover:bg-indigo-700"><i class="fas fa-paper-plane text-xs"></i></button>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const DB_KEY = 'LifeOS_Ultimate_Fix_v2';
        
        let db = {
            tasks: [],
            goals: { daily: [], global: [] },
            finances: { transactions: [] },
            nexus: { sessions: [], xp: 0, level: 1 },
            habits: [],
            textContent: {}
        };

        // --- LIFE AI ENGINE 2.0 (MELHORADO) ---
        const LifeAI = {
            generateInsight: () => {
                const hour = new Date().getHours();
                let category = "general";
                
                if (hour < 12) category = "morning";
                else if (hour < 18) category = "afternoon";
                else category = "evening";

                const insightsDB = {
                    morning: [
                        "‚òÄÔ∏è Bom dia! 'A melhor maneira de prever o futuro √© cri√°-lo'. Revise suas metas hoje.",
                        "üöÄ Foco matinal: Ataque a tarefa mais dif√≠cil primeiro (Eat the Frog).",
                        "‚òï Comece o dia organizando sua lista. Clareza gera velocidade."
                    ],
                    afternoon: [
                        "‚ö° Energia p√≥s-almo√ßo: Se estiver cansado, fa√ßa 5 min de pausa ativa.",
                        "üß† Lembrete: Multitarefa reduz o QI. Foque em uma coisa de cada vez.",
                        "üíß J√° bebeu √°gua hoje? Hidrata√ß√£o melhora o foco cognitivo."
                    ],
                    evening: [
                        "üåô O dia est√° acabando. O que voc√™ aprendeu hoje?",
                        "üßò Desacelere. Prepare sua lista de amanh√£ para dormir tranquilo.",
                        "‚ú® Pequenos progressos di√°rios somam grandes resultados. Bom descanso."
                    ],
                    general: [
                        "üí° Dica Financeira: Regra 50/30/20 ajuda a equilibrar o or√ßamento.",
                        "üìö Estudo Ativo: Tente explicar o que aprendeu para uma crian√ßa (Feynman).",
                        "üå± H√°bito √© repeti√ß√£o. N√£o quebre a corrente!"
                    ]
                };

                const pool = [...insightsDB[category], ...insightsDB.general];
                const msg = pool[Math.floor(Math.random() * pool.length)];
                
                document.getElementById('ai-daily-insight').innerText = msg;
            },
            suggestDailyGoals: () => {
                const ideas = ["Revisar e-mails", "Leitura de 15min", "Organizar arquivos", "Planejamento Financeiro", "Estudar 1 Pomodoro"];
                const pick = ideas[Math.floor(Math.random() * ideas.length)];
                db.goals.daily.push({id: Date.now(), text: pick, done: false});
                saveDB(); renderDaily();
            }
        };

        // --- CORE FUNCTIONS ---
        function init() {
            loadDB();
            updateDate();
            renderDashboard();
            LifeAI.generateInsight();
            setupAutoSave();
        }

        function loadDB() {
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                db = { ...db, ...JSON.parse(saved) };
                if(db.textContent) {
                    for (const [id, text] of Object.entries(db.textContent)) {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = text;
                    }
                }
            }
        }

        function saveDB() {
            // Salva inputs de texto edit√°vel
            document.querySelectorAll('[contenteditable="true"]').forEach(el => {
                if(el.id) db.textContent[el.id] = el.innerHTML;
            });
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        }

        function setupAutoSave() {
            document.body.addEventListener('input', (e) => {
                if (e.target.getAttribute('contenteditable') === 'true') saveDB();
            });
        }
        
        function saveTextData() { saveDB(); }

        function updateDate() {
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('pt-BR', options);
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = document.getElementById(`btn-${id}`);
            if(btn) btn.classList.add('active');

            if(id === 'daily') renderDaily();
            if(id === 'goals') renderGoals();
            if(id === 'finances') renderFinances();
            if(id === 'study') renderNexusDashboard();
            if(id === 'routine') renderRoutine();
        }

        // --- RENDERERS ---
        function renderDashboard() { /* Visual only */ }

        function renderDaily() {
            const container = document.getElementById('daily-goals-container');
            container.innerHTML = '';
            db.goals.daily.forEach(g => {
                container.innerHTML += `<div class="flex items-center gap-3 mb-2 p-2 rounded hover:bg-slate-50 group transition"><input type="checkbox" ${g.done?'checked':''} onchange="toggleGoal('daily',${g.id})" class="accent-indigo-600 w-4 h-4 cursor-pointer"><span class="${g.done?'line-through text-slate-400':'text-slate-700'} text-sm font-medium flex-1">${g.text}</span><button onclick="deleteGoal('daily',${g.id})" class="text-xs text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button></div>`;
            });
            renderTasks();
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            if(db.tasks.length === 0) list.innerHTML = '<p class="text-slate-400 text-sm italic text-center py-4">Nenhuma tarefa pendente.</p>';
            db.tasks.forEach(t => {
                list.innerHTML += `<div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-lg mb-2 shadow-sm hover:border-indigo-200 transition group"><input type="checkbox" ${t.done?'checked':''} onchange="toggleTask(${t.id})" class="accent-indigo-600 w-5 h-5 cursor-pointer"><span class="flex-1 text-sm ${t.done?'text-slate-400 line-through':'text-slate-700 font-medium'}">${t.text}</span><button onclick="deleteTask(${t.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button></div>`;
            });
        }

        function renderGoals() {
            const grid = document.getElementById('global-goals-grid');
            grid.innerHTML = '';
            const cats = ['Pessoal', 'Profissional', 'Financeiro'];
            cats.forEach(cat => {
                const goals = db.goals.global.filter(g => g.category === cat);
                let html = `<div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-full"><div class="flex justify-between mb-4 items-center"><h3 class="font-bold text-slate-700 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-indigo-500"></div> ${cat}</h3><button onclick="addGlobalGoal('${cat}')" class="text-indigo-500 hover:bg-indigo-50 p-1.5 rounded-md transition"><i class="fas fa-plus"></i></button></div>`;
                if(goals.length === 0) html += '<p class="text-xs text-slate-400 italic">Sem metas.</p>';
                goals.forEach(g => {
                    html += `<div class="mb-4 group"><div class="flex justify-between text-sm mb-1 font-medium text-slate-700"><span>${g.text}</span><span class="text-xs text-indigo-500">${g.progress}%</span></div><div class="w-full bg-slate-100 rounded-full h-2 cursor-pointer relative overflow-hidden" onclick="updateGoalProgress(${g.id})"><div class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: ${g.progress}%"></div></div><button onclick="deleteGlobalGoal(${g.id})" class="text-[10px] text-red-300 hover:text-red-500 mt-1 opacity-0 group-hover:opacity-100 transition">Excluir</button></div>`;
                });
                html += `</div>`;
                grid.innerHTML += html;
            });
        }

        function renderFinances() {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            let bal = 0, inc = 0, exp = 0;
            if(db.finances.transactions.length === 0) list.innerHTML = '<p class="text-slate-400 text-xs italic text-center py-2">Sem transa√ß√µes.</p>';
            db.finances.transactions.slice().reverse().forEach(t => {
                if(t.type === 'income') { bal += t.val; inc += t.val; } else { bal -= t.val; exp += t.val; }
                list.innerHTML += `<div class="flex justify-between p-3 border-b border-slate-50 text-sm hover:bg-slate-50 transition"><span>${t.desc}</span><div class="flex items-center gap-3"><span class="font-mono font-medium ${t.type==='income'?'text-green-600':'text-red-500'}">R$ ${t.val.toFixed(2)}</span><button onclick="deleteTransaction(${t.id})" class="text-xs text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></div>`;
            });
            document.getElementById('fin-balance').innerText = `R$ ${bal.toFixed(2)}`;
            document.getElementById('fin-income').innerText = `R$ ${inc.toFixed(2)}`;
            document.getElementById('fin-expense').innerText = `R$ ${exp.toFixed(2)}`;
        }

        function renderNexusDashboard() {
            const area = document.getElementById('nexus-content-area');
            area.innerHTML = `<div class="bg-indigo-50 p-8 rounded-xl border border-indigo-100 text-center"><h3 class="text-indigo-900 font-bold mb-2 text-xl">Painel de Estudos</h3><p class="text-indigo-600 text-sm mb-4">Registre suas sess√µes para subir de n√≠vel.</p><div class="inline-block bg-white px-6 py-2 rounded-full shadow-sm text-indigo-600 font-bold border border-indigo-100">N√≠vel ${db.nexus.level}</div></div>`;
        }

        function renderRoutine() {
            const list = document.getElementById('habit-list');
            list.innerHTML = '';
            if(db.habits.length === 0) list.innerHTML = '<p class="text-slate-400 italic text-sm">Adicione um h√°bito para come√ßar.</p>';
            db.habits.forEach(h => {
                list.innerHTML += `<div class="flex items-center gap-3 p-3 bg-slate-50 border border-slate-100 rounded-lg mb-2 group"><div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-300 cursor-pointer hover:border-indigo-400 hover:text-indigo-500 transition"><i class="fas fa-check"></i></div><span class="flex-1 text-sm font-medium text-slate-700">${h.text}</span><button onclick="deleteHabit(${h.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button></div>`;
            });
        }

        // --- ACTIONS ---
        function addDailyGoal() { const t = prompt("Nova meta do dia:"); if(t) { db.goals.daily.push({id:Date.now(), text:t, done:false}); saveDB(); renderDaily(); } }
        function toggleGoal(type, id) { const g = db.goals[type].find(x=>x.id===id); if(g){g.done=!g.done; saveDB(); renderDaily();} }
        function deleteGoal(type, id) { db.goals[type] = db.goals[type].filter(x=>x.id!==id); saveDB(); renderDaily(); }
        
        function addTask() { const t = document.getElementById('new-task-input').value; if(t){ db.tasks.push({id:Date.now(), text:t, done:false}); document.getElementById('new-task-input').value=''; saveDB(); renderTasks(); } }
        function toggleTask(id) { const t = db.tasks.find(x=>x.id===id); if(t){t.done=!t.done; saveDB(); renderTasks();} }
        function deleteTask(id) { db.tasks = db.tasks.filter(x=>x.id!==id); saveDB(); renderTasks(); }

        function addTransaction() {
            const type = document.getElementById('trans-type').value;
            const val = parseFloat(document.getElementById('trans-val').value);
            const desc = document.getElementById('trans-desc').value;
            if(desc && !isNaN(val)) { db.finances.transactions.push({id:Date.now(), type, val, desc}); saveDB(); renderFinances(); document.getElementById('trans-desc').value=''; document.getElementById('trans-val').value=''; }
        }
        function deleteTransaction(id) { db.finances.transactions = db.finances.transactions.filter(x=>x.id!==id); saveDB(); renderFinances(); }

        function addGlobalGoal(cat) { const t = prompt("Nova meta:"); if(t) { db.goals.global.push({id:Date.now(), category:cat, text:t, progress:0}); saveDB(); renderGoals(); } }
        function deleteGlobalGoal(id) { db.goals.global = db.goals.global.filter(x=>x.id!==id); saveDB(); renderGoals(); }
        function updateGoalProgress(id) { const g = db.goals.global.find(x=>x.id===id); const p = prompt("Novo progresso (0 a 100):", g.progress); if(p!==null && !isNaN(p)) { g.progress = Math.min(100, Math.max(0, parseInt(p))); saveDB(); renderGoals(); } }

        function addHabit() { const t = prompt("Novo h√°bito:"); if(t) { db.habits.push({id:Date.now(), text:t}); saveDB(); renderRoutine(); } }
        function deleteHabit(id) { db.habits = db.habits.filter(x=>x.id!==id); saveDB(); renderRoutine(); }

        // --- SYSTEM ---
        function exportData() {
            const dataStr = JSON.stringify(db);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.href = dataUri; link.download = 'lifeos_backup.json'; link.click();
        }
        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                if(confirm("Isso substituir√° seus dados atuais. Continuar?")) {
                    db = JSON.parse(e.target.result);
                    saveDB(); location.reload();
                }
            };
            reader.readAsText(file);
        }
        function hardReset() { if(confirm("ATEN√á√ÉO: Isso apagar√° TODOS os dados. Continuar?")) { localStorage.removeItem(DB_KEY); location.reload(); } }

        // --- AI CHAT ---
        function toggleAIChat() { const w = document.getElementById('ai-chat-window'); w.style.display = w.style.display==='flex'?'none':'flex'; if(w.style.display==='flex') w.classList.add('open'); }
        function handleAIChat(e) {
            e.preventDefault(); const i = document.getElementById('ai-chat-input'); const m = i.value; if(!m)return;
            const l = document.getElementById('ai-chat-messages');
            l.innerHTML += `<div class="flex justify-end"><div class="bg-indigo-600 text-white p-3 rounded-2xl rounded-tr-none text-sm max-w-[85%] shadow-sm">${m}</div></div>`;
            i.value = '';
            setTimeout(() => {
                l.innerHTML += `<div class="flex justify-start"><div class="bg-white p-3 rounded-2xl rounded-tl-none text-sm shadow-sm text-slate-700 border border-slate-100">Entendi! Vou processar isso. (IA Simulada)</div></div>`;
                l.scrollTop = l.scrollHeight;
            }, 600);
        }

        // --- TIMER ---
        let tTime = 25*60; let tInt; let tRun = false;
        function toggleStudyTimer() {
            if(tRun) { clearInterval(tInt); tRun=false; document.getElementById('nexus-timer-btn').innerText="Focar"; }
            else { tRun=true; document.getElementById('nexus-timer-btn').innerText="Pausar"; tInt=setInterval(()=>{ tTime--; const m=Math.floor(tTime/60).toString().padStart(2,'0'); const s=(tTime%60).toString().padStart(2,'0'); document.getElementById('nexus-timer').innerText=`${m}:${s}`; if(tTime<=0){clearInterval(tInt);tRun=false;alert("Tempo Esgotado!");tTime=25*60;} },1000); }
        }

        init();
    </script>
</body>
</html>
